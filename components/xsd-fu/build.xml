<?xml version="1.0" encoding="utf-8"?>
<project name="xsd-fu" default="runall" basedir=".">
  <description>Build file for xsd-fu</description>
  <property name="root.dir" location="../.."/>
  <property name="xsdfu.schemaver" value="2012-06"/>
  <property name="xsdfu.schemapath" value="../specification/released-schema/${xsdfu.schemaver}"/>
  <property name="xsdfu.ome" value="${xsdfu.schemapath}/ome.xsd"/>
  <property name="xsdfu.binaryfile" value="${xsdfu.schemapath}/BinaryFile.xsd"/>
  <property name="xsdfu.roi" value="${xsdfu.schemapath}/ROI.xsd"/>
  <property name="xsdfu.sa" value="${xsdfu.schemapath}/SA.xsd"/>
  <property name="xsdfu.spw" value="${xsdfu.schemapath}/SPW.xsd"/>
  <import file="${root.dir}/ant/java.xml"/>

  <target name="package"><!-- Skip compile -->
    <property name="py.target" value="${basedir}/build/lib"/>
    <mkdir dir="${py.target}"/>
    <setup_py>
      <env key="BF_VERSION" value="${release.version}"/>
      <arg value="build"/>
      <arg value="--build-platlib"/>
      <arg value="${py.target}"/>
      <arg value="--build-purelib"/>
      <arg value="${py.target}"/>
    </setup_py>
    <setup_py>
      <env key="BF_VERSION" value="${release.version}"/>
      <arg value="bdist_egg"/>
      <arg value="--dist-dir"/>
      <arg value="${target.dir}"/>
    </setup_py>
    <move todir="${target.dir}">
      <fileset dir="${target.dir}"/>
      <mapper type="regexp" from="(xsd_fu-.*?)-py(.*?).egg" to="xsd-fu.egg" />
    </move>
  </target>
  <target name="install" depends="package">
    <!-- Defining here to work around jar signing -->
    <publishArtifact/>
  </target>

  <target name="test-compile" description="No-op"/>
  <target name="test" description="No-op"/>
  <target name="integration" description="No-op"/>
  <target name="findbugs" description="No-op"/>

  <target name="runall" depends="run-3to8,run-7to8,run-8to8,run-8to9,run-3to9"/>
  <target name="run-3to8">
    <exec executable="./xslt/xslt-test2003FCTo200809"/>
  </target>
  <target name="run-7to8">
    <exec executable="./xslt/xslt-test200706To200809"/>
  </target>
  <target name="run-8to8">
    <exec executable="./xslt/xslt-test200802To200809"/>
  </target>
  <target name="run-8to9">
    <exec executable="./xslt/xslt-test200809To200909"/>
  </target>
  <target name="run-3to9">
    <exec executable="./xslt/xslt-test2003FCTo200809To200909"/>
  </target>

  <macrodef name="xsd_fu" description="Run xsd_fu">
    <attribute name="package" default="ome.xml.model"/>
    <attribute name="lang" default="Java"/>
    <attribute name="output"/>
    <element name="args" implicit="yes"/>
    <sequential>
      <exec executable="python" failonerror="true">
	<arg value="xsd-fu"/>
	<args/>
	<arg value="-p"/>
	<arg value="@{package}"/>
	<arg value="-l"/>
	<arg value="@{lang}"/>
	<arg value="-o"/>
	<arg value="@{output}/"/>
	<arg value="${xsdfu.ome}"/>
	<arg value="${xsdfu.binaryfile}"/>
	<arg value="${xsdfu.roi}"/>
	<arg value="${xsdfu.sa}"/>
	<arg value="${xsdfu.spw}"/>
      </exec>
    </sequential>
  </macrodef>

  <target name="generate-ome-xml">
    <property name="xsdfu.modelpath" value="../ome-xml/build/src/ome/xml/model"/>
    <property name="xsdfu.enumpath" value="../ome-xml/build/src/ome/xml/model/enums"/>
    <property name="xsdfu.handlerpath" value="../ome-xml/build/src/ome/xml/model/enums/handlers"/>

    <!-- Generate the OME model object classes -->
    <xsd_fu package="ome.xml.model" lang="Java" output="${xsdfu.modelpath}">
      <arg value="java_classes"/>
    </xsd_fu>

    <!-- Generate the OME model enumeration classes -->
    <xsd_fu package="ome.xml.model.enums" lang="Java" output="${xsdfu.enumpath}">
      <arg value="enum_types"/>
    </xsd_fu>

    <!-- Generate the handlers for the OME model enumeration classes -->
    <xsd_fu package="ome.xml.model.enums.handlers" lang="Java" output="${xsdfu.handlerpath}">
      <arg value="enum_handlers"/>
    </xsd_fu>
  </target>

  <target name="generate-metadata">
    <property name="xsdfu.metadatapath" value="../scifio/build/src/loci/formats/meta"/>

    <!-- Generate the metadata interfaces -->
    <xsd_fu lang="Java" output="${xsdfu.metadatapath}">
      <arg value="metadata_store"/>
    </xsd_fu>
    <xsd_fu lang="Java" output="${xsdfu.metadatapath}">
      <arg value="metadata_retrieve"/>
    </xsd_fu>
    <!-- Generate the metadata implementations -->
    <xsd_fu lang="Java" output="${xsdfu.metadatapath}">
      <arg value="metadata_aggregate"/>
    </xsd_fu>
    <xsd_fu lang="Java" output="${xsdfu.metadatapath}">
      <arg value="dummy_metadata"/>
    </xsd_fu>
    <xsd_fu lang="Java" output="${xsdfu.metadatapath}">
      <arg value="filter_metadata"/>
    </xsd_fu>

  </target>

  <target name="generate-ome-xml-metadata">
    <property name="xsdfu.scifiopath" value="../scifio/build/src/loci/formats/ome"/>

    <xsd_fu lang="Java" output="${xsdfu.scifiopath}">
      <arg value="omexml_metadata"/>
    </xsd_fu>
  </target>

  <target name="clean" description="Cleans the published schemas and specification jar">
    <delete>
      <fileset dir="xslt" includes="**/*.pyc"/>
      <fileset dir="python" includes="**/*.pyc"/>
    </delete>
  </target>

</project>
